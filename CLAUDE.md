# CLAUDE.md

## Project

Kirkkovuosi API — a zero-dependency Node.js REST API for the liturgical calendar of the Evangelical-Lutheran Church of Finland. Provides church year dates, Bible readings, liturgical propers, and a lectionary Bible index.

## Commands

```bash
npm start           # start server (port 3000, or $PORT)
npm run dev         # start with --watch (auto-restart)
npm test            # run test suite (node --test)
```

## Architecture

ES modules throughout (`"type": "module"` in package.json). No build step.

```
src/
├── index.js            Entry point. Defines Router class, creates HTTP server.
├── routes/api.js       All route handlers. Imports from services/.
├── services/
│   ├── computus.js     Pure functions: Easter date, moveable feasts, date utils.
│   ├── resolver.js     resolveDate() — maps a calendar date to its church day.
│   ├── propers.js      Looks up prefaatiot, kyrie litaniat, etc. from propers.json.
│   └── lectionary.js   Looks up Bible passage index from lectionary-index.json.
├── data/               JSON data files (loaded lazily, cached in memory).
├── tests/api.test.js   Uses node:test. Import from services directly.
└── parsers/            One-off scripts that generate the JSON data files.
```

## Key design points

- **No external dependencies.** Uses only Node.js built-ins: `http`, `fs`, `path`, `url`, `node:test`.
- **Data is loaded lazily and cached.** Each service file has a module-level cache variable initialized on first call.
- **Router** in `src/index.js` converts `:param` patterns to regex. Route handlers in `api.js` receive `{ params, query }`.
- **Church year** starts on 1st Advent Sunday (nearest Sunday to Nov 30). The three-year lectionary cycle is determined by `churchYearStartYear % 3`.
- **Data directory** is resolved relative to the service file's `__dirname`: `join(__dirname, '..', 'data')`.

## Data files

| File | Generated by | Description |
|---|---|---|
| `data/all-days.json` | `parsers/parse-evankeliumikirja.js` | All holy days with readings, prayers, psalms |
| `data/propers.json` | `parsers/parse-jpkirja.js` | Prefaatiot, kyrie litaniat, etc. |
| `data/lectionary-index.json` | `parsers/parse-lectionary-index.js` | 2073 Bible passage → liturgical occasion entries |
| `data/lectionary-index.txt` | `pdftotext` (poppler-utils) | Raw text extracted from the PDF |

To regenerate the lectionary index after changing the PDF:
```bash
pdftotext refs/viikkolektionaarin_raamatunkohdat.pdf src/data/lectionary-index.txt
node src/parsers/parse-lectionary-index.js
```

## Reference documents

Source documents used to generate the data files are kept in `refs/`:

| File | Description |
|---|---|
| `refs/jpkirja.doc` | Jumalanpalvelusten kirja (Kirkkokäsikirja I) — source for propers |
| `refs/viikkolektionaarin_raamatunkohdat.pdf` | Source PDF for lectionary Bible index |

To parse jpkirja, first convert the `.doc` to markdown (e.g. with pandoc), then run:
```bash
node src/parsers/parse-jpkirja.js refs/jpkirja.md src/data
```

## Testing

Tests use `node:test` (built-in). Run with:
```bash
npm test
# or directly:
node --test src/tests/*.test.js
```

Tests import directly from service modules (`../services/computus.js`, `../services/resolver.js`). They do not start the HTTP server. All 30 tests must pass before committing.

## Adding a new API endpoint

1. Add the route handler in `src/routes/api.js` using `routes.get('/api/v1/...', handler)`.
2. Add the endpoint description to the list in `src/index.js` (the root info response).
3. If new data is needed, add a service in `src/services/` and a data file in `src/data/`.

## Finnish terminology

| Finnish | English |
|---|---|
| kirkkovuosi | church year |
| pyhäpäivä | holy day / feast day |
| lukukappale | reading / lesson |
| evankeliumi | gospel |
| psalmi | psalm |
| prefaatio | preface (liturgical) |
| kyrie-litania | Kyrie litany |
| synninpäästö | absolution |
| kertosäe | psalm refrain |
| sunnuntai | Sunday |
| adventtiaika | Advent season |
| paastonaika | Lent |
| pääsiäinen | Easter |
| helluntai | Pentecost |
| loppiainen | Epiphany |
| vuosikerta (vsk.) | lectionary year cycle |
